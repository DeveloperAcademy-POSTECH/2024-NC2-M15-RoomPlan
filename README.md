# 2024-NC2-M15-RoomPlan

## ğŸ¥ Youtube Link (Click the image)
[![Video Label](https://github.com/DeveloperAcademy-POSTECH/2024-NC2-M15-RoomPlan/assets/52344592/6f631d09-955f-420c-bd7c-9b06ce0888b5)](https://youtu.be/Ne4yzAaqqkM?si=25OEI2bubSXvJbl4)

## ğŸ’¡ About RoomPlan

<img width="600" alt="Untitled" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-M15-RoomPlan/assets/52344592/f9e25cee-4259-4663-83ff-33f0d38ea918">
  
>RoomPlanì€ ì¹´ë©”ë¼ì™€ ë¼ì´ë‹¤ì„¼ì„œë¥¼ í™œìš©í•´ì„œ 3D í‰ë©´ë„ë¥¼ ì‘ì„±í•´ì£¼ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

>RoomPlanì„ í™œìš©í•´ì„œ ë‹¤ë¥¸ ê¸°ìˆ ê³¼ ê²°í•©í•˜ì—¬ ë²½ì˜ ìƒ‰ë„ ë°”ê¿”ë³¼ ìˆ˜ ìˆê³  ì“°ì´ëŠ” í˜ì¸íŠ¸ì˜ ì–‘ ê¹Œì§€ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ê³µê°„ ì„¤ê³„, ê°€êµ¬ ë°°ì¹˜ ë“±ì—ë„ í™œìš©í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤.

>ì œì•½ì‚¬í•­:  RoomPlanìœ¼ë¡œ ê³µê°„ì„ ìŠ¤ìº”í•  ë•ŒëŠ” 5ë¶„ì„ ì´ˆê³¼í•˜ë©´ ì•ˆë˜ê³  ìµœëŒ€ ìŠ¤ìº” ë²”ìœ„ëŠ” 9mX9mì…ë‹ˆë‹¤. ê·¸ë¦¬ê³ , ì§ìœ¡ë©´ì²´ë§Œ ì¸ì‹í•˜ê³  ê³¡ì„ ì€ ì¸ì‹ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

## ğŸ¯ What we focus on?
- ì• í”Œì—ì„œ ì œê³µí•œ RoomPlan ì˜ˆì‹œ ì½”ë“œë¥¼ í™œìš©í•˜ì—¬ ê³µê°„ì„ ìº¡ì³í•˜ëŠ” ê¸°ìˆ  ìì²´ì— ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤.
- ìº¡ì³ëœ ëª¨ë¸ì„ USD, USDZ ë“±ì˜ í¬ë§·ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ê²ƒ ì™¸ì—ëŠ” ëª¨ë¸ì„ í™œìš©í•  ë°©ë²•ì´ ë§ˆë•…ì¹˜ ì•Šì•„ ìº¡ì³ëœ ëª¨ë¸ì„ ì–´ë–»ê²Œ ì‚¬ìš©í•´ì•¼í• ì§€ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.
- ìº¡ì³ëœ ëª¨ë¸ì„ ì´ë¯¸ì§€ë¡œ ë§Œë“¤ì–´ì„œ ë‹¤ë¥¸ ì´ë¯¸ì§€, í…ìŠ¤íŠ¸ ë“±ì˜ ìš”ì†Œë“¤ê³¼ í•¨ê»˜ ë°°ì¹˜í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

## ğŸ’¼ Use Case
**RoomPlanê³¼ Mapsë¥¼ í™œìš©í•˜ì—¬ ìƒìƒí•˜ê²Œ ê³µê°„ì„ ê¸°ë¡í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ë³´ì!**

## ğŸ–¼ï¸ Prototype
- Prototype & User Flow
<img width="1932" alt="Untitled 2" src="https://github.com/DeveloperAcademy-POSTECH/2024-NC2-M15-RoomPlan/assets/52344592/18ca4200-5829-4d0a-a5f8-b17c2ff01d4e">

- ì‹œì—°ì˜ìƒ

https://github.com/DeveloperAcademy-POSTECH/2024-NC2-M15-RoomPlan/assets/52344592/330e2af1-cd0a-4aaf-a028-d8ba90d4cfa6

## ğŸ› ï¸ About Code
- RoomPlan

```swift
import RoomPlan
```

```swift
//ë°© ìº¡ì³ë¥¼ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤
class RoomController: RoomCaptureViewDelegate {
    func encode(with coder: NSCoder) {
        fatalError("Not Needed")
    }
    
    required init?(coder: NSCoder) {
        fatalError("Not Needed")
    }
    
    //ì½”ë“œì˜ ë‹¤ë¥¸ ë¶€ë¶„ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì‹±ê¸€í„´ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    static var instance = RoomController()
    
    var captureView: RoomCaptureView
    var sessionConfig: RoomCaptureSession.Configuration = RoomCaptureSession.Configuration()
    var finalResult: CapturedRoom?
    
    init() {
        captureView = RoomCaptureView(frame: .zero)
        captureView.delegate = self
    }
    
    //ìº¡ì³ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ ì•„ë‹Œì§€ì— ëŒ€í•´ì„œ Bool ê°’ì„ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
    func captureView(shouldPresent roomDataForProcessing: CapturedRoomData, error: (Error)?) -> Bool {
        return true
    }
    
    //ìº¡ì³ê°€ ì™„ë£Œëœ ê²°ê³¼ë¥¼ finalResultì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    func captureView(didPresent processedResult: CapturedRoom, error: (Error)?) {
        finalResult = processedResult
    }
    
    //ìº¡ì³ë¥¼ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
    func startSession() {
        captureView.captureSession.run(configuration: sessionConfig)
    }
    
    //ìº¡ì³ë¥¼ ì¢…ë£Œí•˜ëŠ” í•¨ìˆ˜
    func stopSession() {
        captureView.captureSession.stop()
    }
}
```

```swift
//UIKitìœ¼ë¡œ ì‘ì„±ëœ RoomPlan ë·°ë¥¼ SwiftUIì—ì„œ ë³´ì—¬ì§€ë„ë¡ UIViewRepresentable í”„ë¡œí† ì½œì„ ì‚¬ìš©í•œ ë·°
struct RoomCaptureViewRepresentable : UIViewRepresentable {
    //ë·°ë¥¼ ìƒì„±í•˜ê³  ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
    func makeUIView(context: Context) -> RoomCaptureView {
        RoomController.instance.captureView
    }
    
    func updateUIView(_ uiView: RoomCaptureView, context: Context) {
        
    }
}
```

- ëª¨ë¸ ì´ë¯¸ì§€í™” ë° ë°°ê²½ ì œê±°

```swift
//ìº¡ì³ëœ ëª¨ë¸ì´ ë³´ì´ëŠ” ë·°ë¥¼ ì´ë¯¸ì§€ë¡œ ìº¡ì³í•˜ê¸° ìœ„í•œ í•¨ìˆ˜
//3Dëª¨ë¸ì´ ì¡´ì¬í•˜ëŠ” ë¶€ë¶„ë§Œ ìº¡ì³ë˜ë„ë¡ ì˜ì—­ì„ ì¡°ì •í•´ì„œ ì´ë¯¸ì§€ë¡œ ë§Œë“¦
func captureScreen() {
    if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene {
        if let window = windowScene.windows.first(where: { $0.isKeyWindow }) {
            let rootView = window.rootViewController?.view
            let topMargin: CGFloat = 100
            let bottomMargin: CGFloat = 300
            let screenHeight = UIScreen.main.bounds.height
            let screenWidth = UIScreen.main.bounds.width
            let rect = CGRect(x: 0, y: topMargin, width: screenWidth, height: screenHeight - topMargin - bottomMargin)
            capturedView = rootView?.snapshot(of: rect)
        }
    }
}
```

```swift
//ì´ë¯¸ì§€ì˜ ë°°ê²½ì„ ì œê±°í•˜ëŠ” í•¨ìˆ˜
func createSticker(image: UIImage) {
    let processingQueue = DispatchQueue(label: "ProcessingQueue")
        
    guard let inputImage = CIImage(image: image) else {
        print("Failed to create CIImage")
        return
    }
    processingQueue.async {
        guard let maskImage = subjectMaskImage(from: inputImage) else {
            print("Failed to create mask image")
            DispatchQueue.main.async {
            }
            return
        }
        let outputImage = apply(mask: maskImage, to: inputImage)
        let image = render(ciImage: outputImage)
        DispatchQueue.main.async {
            self.model = image
        }
    }
}
```

```swift
//ì´ë¯¸ì§€ì˜ ë°°ê²½ì„ ì œê±°í•˜ê¸° ìœ„í•œ Maskë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜
func subjectMaskImage(from inputImage: CIImage) -> CIImage? {
    let handler = VNImageRequestHandler(ciImage: inputImage, options: [:])
    let request = VNGenerateForegroundInstanceMaskRequest()
        
    do {
        try handler.perform([request])
        guard let result = request.results?.first else {
            print("No observations found")
            return nil
        }
        let maskPixelBuffer = try result.generateScaledMaskForImage(forInstances: result.allInstances, from: handler)
        return CIImage(cvPixelBuffer: maskPixelBuffer)
    } catch {
        print(error)
        return nil
    }
}
```

```swift
//ì´ë¯¸ì§€ì— Maskë¥¼ ì ìš©í•˜ëŠ” í•¨ìˆ˜
func apply(mask: CIImage, to image: CIImage) -> CIImage {
    let filter = CIFilter.blendWithMask()
    filter.inputImage = image
    filter.maskImage = mask
    filter.backgroundImage = CIImage.empty()
    return filter.outputImage!
}
```

```swift
//ì´ë¯¸ì§€ì— ì ìš©ëœ Maskì— ë”°ë¼ ë°°ê²½ì„ ì œê±°í•œ ì´ë¯¸ì§€ë¥¼ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
func render(ciImage: CIImage) -> UIImage {
    guard let cgImage = CIContext(options: nil).createCGImage(ciImage, from: ciImage.extent) else {
        fatalError("Failed to render CGImage")
    }
    return UIImage(cgImage: cgImage)
}
```

- ì •ë³´ ì €ì¥ ë° ê´€ë¦¬(SwiftData)

```swift
@Model
final class SpaceData: Identifiable {
    var id: UUID
    var date: String
    var comment: String
    @Attribute(.externalStorage) var model: Data
    @Attribute(.externalStorage) var background: Data
    var latitude: Double
    var longitude: Double
    
    init(id: UUID, date: String, comment: String, model: Data, background: Data, latitude: Double, longitude: Double) {
        self.id = id
        self.date = date
        self.comment = comment
        self.model = model
        self.background = background
        self.latitude = latitude
        self.longitude = longitude
    }
}
```

```swift
//SwiftDataì— ê³µê°„ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
func addSpace() {
    let formatter = DateFormatter()
    formatter.dateFormat = "yyyyë…„ Mì›” dì¼"
    let savedDate = formatter.string(from: date)
        
    do {
        if let model {
            if let background {
                let newSpace = SpaceData(
                    id: UUID(),
                    date: savedDate,
                    comment: comment,
                    model: model.pngData()!,
                    background: background.pngData()!,
                    latitude: latitude,
                    longitude: longitude
                )
                    
                modelContext.insert(newSpace)
                try modelContext.save()
            }
        }
    } catch {
        print("Failed to save data")
    }
}
```

```swift
//SwiftDataì—ì„œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
func deleteSpace(space: SpaceData) {
    do {
        modelContext.delete(space)
        try modelContext.save()
    } catch {
        print("Failed to save data")
    }
}
```
